# 個別支援計画GPT連携機能 - テストガイド

## テスト前の準備

### 1. 環境変数の設定

`.env.local` ファイルにOpenAI APIキーが設定されているか確認：

```bash
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 2. 開発サーバーの起動

```bash
pnpm dev
```

サーバーが `http://localhost:3000` で起動することを確認。

## テスト手順

### ステップ1: ダッシュボードへのアクセス

1. ブラウザで `http://localhost:3000` を開く
2. ログイン画面でテストアカウントを使用してログイン
   - メールアドレス: `supporter@example.com`
   - パスワード: `password123`

### ステップ2: データ分析画面への移動

1. 左サイドバーから「データ分析」をクリック
2. または、URL `http://localhost:3000/dashboard/analysis` に直接アクセス

### ステップ3: 当事者の選択

1. 「分析対象の選択」カードで当事者を選択（例: 佐藤 次郎）
2. ドロップダウンメニューから任意の当事者を選択

### ステップ4: GPT連携の確認

1. 当事者を選択後、「AI支援計画生成（GPT連携）」トグルが表示されることを確認
2. トグルがON（デフォルト）になっていることを確認
3. トグルの下に「30事例以上の支援事例を活用した最適な支援計画を提案」と表示されていることを確認

### ステップ5: 個別支援計画の生成（GPT連携ON）

1. 「個別支援計画」ボタンをクリック
2. ボタンに✨アイコンと「AI推奨」バッジが表示されていることを確認
3. ローディング画面が表示される
   - 「GPTを使用して30事例以上の支援事例から最適な支援計画を策定しています」というメッセージを確認
4. 生成が完了するまで待機（約5-10秒）
5. 支援計画が表示されることを確認

### ステップ6: 生成された支援計画の確認

以下の内容が含まれているか確認：

#### アセスメント結果
- [ ] 現在の状態
- [ ] リスクレベル
- [ ] 強み・リソース
- [ ] 課題・支援ニーズ
- [ ] 心理状態（感情、ストレス、意欲）
- [ ] 身体状態（睡眠、活動、自律神経）
- [ ] 社会性（家族関係、会話、外部活動）

#### 支援方針・ポイント
- [ ] 基本的なアプローチ
- [ ] 支援のポイント
- [ ] 留意点

#### 支援目標
- [ ] 短期目標（1-3ヶ月）
- [ ] 中期目標（3-6ヶ月）
- [ ] 長期目標（6-12ヶ月）
- [ ] 各目標に具体的な取り組みと達成基準

#### タブ内容
1. **支援内容タブ**
   - [ ] 各支援プログラムの詳細
   - [ ] 実施のポイント
   - [ ] 期待される成果

2. **役割分担タブ**
   - [ ] 支援チームの構成
   - [ ] 各担当者の責務

3. **評価指標タブ**
   - [ ] 測定方法
   - [ ] 評価頻度
   - [ ] 目標値

4. **類似事例タブ**
   - [ ] 過去の成功事例
   - [ ] 効果的だったアプローチ
   - [ ] 応用ポイント

#### リスク管理
- [ ] 想定されるリスク
- [ ] 予防的対策
- [ ] 緊急連絡先

#### 備考
- [ ] 特記事項

### ステップ7: エクスポート機能の確認

1. 「計画をエクスポート」ボタンをクリック
2. エクスポート処理が実行されることを確認
3. アラートで「エクスポートが完了しました」と表示されることを確認

### ステップ8: GPT連携OFF時のテスト（フォールバック確認）

1. 別の当事者を選択
2. 「AI支援計画生成（GPT連携）」トグルをOFFにする
3. 「個別支援計画」ボタンをクリック
4. ✨アイコンと「AI推奨」バッジが表示されないことを確認
5. ローディングメッセージが「アセスメント結果から個別支援計画を策定しています」と表示されることを確認
6. モックデータを使用した支援計画が表示されることを確認

## エラーケースのテスト

### テストケース1: APIキーが未設定

1. `.env.local` から `OPENAI_API_KEY` を削除またはコメントアウト
2. 開発サーバーを再起動
3. GPT連携ONで個別支援計画を生成
4. **期待される動作**: エラー後、自動的にモックデータを使用
5. ブラウザのコンソールに「GPT連携に失敗しました。モックデータを使用します。」と表示されることを確認

### テストケース2: 無効なAPIキー

1. `.env.local` の `OPENAI_API_KEY` に無効な値を設定
2. 開発サーバーを再起動
3. GPT連携ONで個別支援計画を生成
4. **期待される動作**: エラー後、自動的にモックデータを使用
5. ブラウザのコンソールにエラーメッセージが表示されることを確認

### テストケース3: ネットワークエラー

1. 開発ツールのネットワークタブを開く
2. オフラインモードを有効化
3. GPT連携ONで個別支援計画を生成
4. **期待される動作**: エラー後、自動的にモックデータを使用

## デバッグ情報の確認

### ブラウザコンソール

開発者ツールのコンソールタブで以下を確認：

```javascript
// GPT連携成功時
// (エラーなし)

// GPT連携失敗時（フォールバック）
console.warn("GPT連携に失敗しました。モックデータを使用します。")
console.error("GPT support plan generation error:", error)
```

### ネットワークタブ

1. 開発者ツールのネットワークタブを開く
2. `/api/support-plan/generate` へのPOSTリクエストを確認
3. リクエストボディに以下が含まれることを確認：
   - `patientId`
   - `patientName`
   - `conversationData`
   - `vitalData`
4. レスポンスに支援計画のJSONが含まれることを確認

### サーバーログ

ターミナルで開発サーバーのログを確認：

```bash
# 成功時
# (特にログなし)

# エラー時
Support plan generation error: [エラー詳細]
```

## パフォーマンステスト

### レスポンスタイム計測

1. ブラウザの開発者ツールを開く
2. ネットワークタブで `/api/support-plan/generate` のタイミングを確認
3. **目標**: 10秒以内にレスポンスが返ること

### 複数回実行

1. 同じ当事者で3回連続で支援計画を生成
2. 毎回異なる内容が生成されることを確認（GPTの応答にランダム性があるため）
3. エラーが発生しないことを確認

## テスト結果チェックリスト

### 基本機能
- [ ] 当事者の選択が正常に動作する
- [ ] GPT連携トグルの切り替えが正常に動作する
- [ ] 個別支援計画ボタンのクリックが正常に動作する
- [ ] ローディング表示が正しく表示される
- [ ] 支援計画が正常に生成される
- [ ] エクスポート機能が正常に動作する

### GPT連携（ON）
- [ ] GPT APIが呼び出される
- [ ] 会話データとバイタルデータが正しく送信される
- [ ] GPTからの応答が正しくパースされる
- [ ] 生成された支援計画が期待通りの構造を持つ
- [ ] ✨アイコンと「AI推奨」バッジが表示される

### GPT連携（OFF）
- [ ] モックデータが使用される
- [ ] GPT APIが呼び出されない
- [ ] ✨アイコンと「AI推奨」バッジが表示されない

### エラーハンドリング
- [ ] APIキー未設定時にフォールバックする
- [ ] 無効なAPIキー時にフォールバックする
- [ ] ネットワークエラー時にフォールバックする
- [ ] エラーメッセージが適切に表示される

### UI/UX
- [ ] レイアウトが崩れていない
- [ ] レスポンシブデザインが正常に動作する
- [ ] ダークモードが正常に動作する
- [ ] アクセシビリティが確保されている

## 既知の制限事項

1. **カスタムGPTの直接利用不可**
   - 指定されたカスタムGPT（`https://chatgpt.com/g/g-6908277e89748191b8a7d60591a4f28d`）は直接APIからアクセスできない
   - 現在はChat Completions APIを使用してプロンプトで支援事例を提供

2. **支援事例データ**
   - 現在はプロンプト内に埋め込み
   - 将来的にはVector Storeを使用した実装を推奨

3. **パフォーマンス**
   - GPT-4のレスポンスタイムは5-15秒程度
   - ネットワーク状況により変動する可能性がある

## トラブルシューティング

### 支援計画が生成されない

1. `.env.local` のAPIキーを確認
2. 開発サーバーを再起動
3. ブラウザのキャッシュをクリア
4. コンソールログでエラーを確認

### GPT連携が常にフォールバックする

1. OpenAI APIキーの有効性を確認
2. OpenAI Platformでアカウントの状態を確認
3. APIの利用制限に達していないか確認
4. ネットワーク接続を確認

### レスポンスが遅い

1. OpenAI APIのステータスページを確認
2. ネットワーク接続を確認
3. 入力データのサイズを確認（大きすぎる場合は最適化を検討）

## 追加テスト（オプション）

### 自動テスト（将来実装）

```typescript
// Jest/Vitestを使用した単体テスト例
describe('generateSupportPlanWithGPT', () => {
  it('should generate support plan with valid data', async () => {
    const plan = await generateSupportPlanWithGPT('1', '佐藤 次郎');
    expect(plan).toHaveProperty('patientId', '1');
    expect(plan).toHaveProperty('patientName', '佐藤 次郎');
    expect(plan.goals).toBeInstanceOf(Array);
    expect(plan.similarCases).toBeInstanceOf(Array);
  });

  it('should fallback to mock data on error', async () => {
    // Mock API error
    jest.spyOn(global, 'fetch').mockRejectedValue(new Error('API Error'));
    const plan = await generateSupportPlanWithGPT('1', '佐藤 次郎');
    expect(plan).toBeDefined();
  });
});
```

### E2Eテスト（将来実装）

```typescript
// Playwright/Cypressを使用したE2Eテスト例
test('should generate support plan with GPT', async ({ page }) => {
  await page.goto('http://localhost:3000/dashboard/analysis');
  await page.selectOption('[data-testid="patient-select"]', '2');
  await page.click('[data-testid="gpt-toggle"]');
  await page.click('button:has-text("個別支援計画")');
  await page.waitForSelector('[data-testid="support-plan-view"]');
  const planContent = await page.textContent('[data-testid="support-plan-view"]');
  expect(planContent).toContain('アセスメント結果');
  expect(planContent).toContain('支援目標');
});
```

---

**最終更新**: 2025年11月5日  
**バージョン**: 1.0.0

