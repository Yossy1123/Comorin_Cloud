# 匿名化ポリシー

## 概要

本ドキュメントでは、ひきこもり支援×AI最適化プラットフォームにおける個人情報の匿名化ルールを定義します。

個人情報保護法に準拠し、利用者のプライバシーを保護するため、本システムでは氏名等の個人を特定できる情報は使用せず、**匿名化ID**のみで利用者を識別します。

---

## 匿名化IDのフォーマット

### 形式

```
YY-NNN
```

### 構成要素

| 要素 | 説明 | 例 |
|------|------|-----|
| YY | 利用開始した西暦の下2桁 | 25 = 2025年 |
| - | ハイフン（区切り文字） | - |
| NNN | 3桁の個別ID（ゼロパディング） | 001〜999 |

### 例

| 匿名化ID | 意味 |
|----------|------|
| `25-001` | 2025年に利用開始した1番目の利用者 |
| `25-022` | 2025年に利用開始した22番目の利用者 |
| `26-001` | 2026年に利用開始した1番目の利用者 |

---

## 採番ルール

### 年度リセット

- 個別ID（NNN）は**毎年1月1日にリセット**されます
- 新年の最初の登録者は `XX-001` となります

### シーケンス範囲

- 最小値: `001`
- 最大値: `999`
- 年間最大登録数: **999名**

### 正規表現パターン

```regex
^(\d{2})-(\d{3})$
```

---

## 実装詳細

### ユーティリティ関数

匿名化IDの生成・検証には、`lib/anonymous-id.ts` のユーティリティ関数を使用してください。

```typescript
import { 
  generateAnonymousId,
  generateAnonymousIdForCurrentYear,
  isValidAnonymousId,
  parseAnonymousId 
} from "@/lib/anonymous-id"

// ID生成
const id = generateAnonymousId(2025, 22) // "25-022"

// 現在年でID生成
const idForCurrentYear = generateAnonymousIdForCurrentYear(1) // "25-001" (2025年の場合)

// ID検証
const isValid = isValidAnonymousId("25-022") // true

// IDパース
const components = parseAnonymousId("25-022") 
// { year: 25, sequence: 22 }
```

### データベーススキーマ

Prismaスキーマでは、`Patient` モデルの `anonymousId` フィールドに匿名化IDを格納します。

```prisma
model Patient {
  id              String   @id @default(uuid())
  
  /// 匿名化ID - 個人を特定できない形式のID
  /// フォーマット: YY-NNN
  anonymousId     String   @unique
  
  /// 利用開始日 - 匿名化IDの年部分の根拠となる日付
  registeredAt    DateTime @default(now())
  
  // ... その他のフィールド
}
```

---

## 禁止事項

### 使用禁止の個人情報

以下の情報は、システム内で**使用・保存してはいけません**：

- ❌ 氏名（漢字、ひらがな、カタカナ、ローマ字）
- ❌ 住所
- ❌ 電話番号
- ❌ メールアドレス（利用者の）
- ❌ その他、個人を特定できる情報

### 表示ルール

- UI上での利用者表示は「ID: XX-NNN」形式で行う
- ファイル名に利用者情報を含める場合は匿名化IDのみを使用
- ログ出力時も匿名化IDのみを使用

---

## 運用ガイドライン

### 新規利用者の登録

1. 登録日の年を確認（西暦下2桁）
2. その年の現在の最大シーケンス番号を取得
3. シーケンス番号をインクリメント
4. 匿名化IDを生成
5. データベースに保存

### 年次処理

1. 毎年1月1日に新年度の採番がリセット
2. 前年のデータは匿名化IDのまま保持
3. 新年最初の登録者は `XX-001` から開始

### データエクスポート

- エクスポートファイル名: `[種別]_[匿名化ID]_[日付].[拡張子]`
- 例: `日報_25-022_2025-12-03.pdf`
- 例: `個別支援計画_25-001_2025-12-03.pdf`

---

## 会話テキストの個人名マスキング

会話データなどのテキスト内に含まれる可能性のある個人名を自動的に検出し、マスキング（`***`に置換）する機能を実装しています。

### 対象となるパターン

個人名マスキングは、以下のパターンを検出します：

1. **敬称付きの名前**
   - `田中さん` → `***さん`
   - `山田先生` → `***先生`
   - `佐藤くん` → `***くん`
   - 対応敬称: さん、くん、君、ちゃん、様、殿、先生、氏、さま

2. **除外パターン**（マスキングしない）
   - `支援者さん`、`当事者さん`、`担当者さん`、`相談者さん`
   - `利用者さん`、`参加者さん`、`対象者さん`

### ユーティリティ関数

個人名マスキングには、`lib/name-masking.ts` のユーティリティ関数を使用してください。

```typescript
import { 
  maskPersonalNames,
  hasPersonalNames,
  detectPersonalNames 
} from "@/lib/name-masking"

// 個人名をマスキング
const masked = maskPersonalNames("田中さんと話しました")
// => "***さんと話しました"

// 個人名が含まれているかチェック
const hasNames = hasPersonalNames("田中さんと話しました")
// => true

// 検出された個人名パターンを取得（デバッグ用）
const detected = detectPersonalNames("田中さんと山田先生と話しました")
// => ["田中さん", "山田先生"]
```

### 適用箇所

個人名マスキングは、以下のコンポーネントで自動的に適用されます：

- 会話履歴（`conversation-history.tsx`）
- 会話分析（`conversation-analysis.tsx`）
- 日報ビュー（`daily-report-view.tsx`）

---

## 関連ファイル

| ファイル | 説明 |
|----------|------|
| `lib/anonymous-id.ts` | 匿名化IDユーティリティ関数 |
| `lib/name-masking.ts` | 個人名マスキングユーティリティ関数 |
| `lib/mock-patients.ts` | モック患者データ（開発用） |
| `prisma/schema.prisma` | データベーススキーマ |
| `types/assessment.ts` | アセスメントデータ型定義 |

---

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-03 | 初版作成 |
| 2025-12-03 | 会話テキストの個人名マスキング機能を追加 |

---

**最終更新**: 2025年12月3日

