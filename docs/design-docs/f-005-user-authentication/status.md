# F-005: ユーザー認証機能（Clerk統合）- 実装状況

本ドキュメントでは、F-005ユーザー認証機能のClerk統合に関する実装状況、フェーズ別計画、タスク管理を記載します。

**最終更新日**: 2025年10月23日

---

## 📊 実装進捗サマリー

### 全体進捗

**進捗**: 1/18項目完了（UIレベル - モック実装）

```
█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 5.6% (モックUI完成)
░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  0%  (Clerk統合)
```

| カテゴリ | 完了 | 進行中 | 未着手 |
|---------|-----|--------|--------|
| Clerk基盤構築 | 0/5 | 0/5 | 5/5 |
| 認証機能実装 | 0/6 | 0/6 | 6/6 |
| RBAC実装 | 0/5 | 0/5 | 5/5 |
| セッション管理 | 0/4 | 0/4 | 4/4 |
| ユーザー管理 | 0/4 | 0/4 | 4/4 |
| モック削除・移行 | 0/3 | 0/3 | 3/3 |

---

## 1. 機能実装状況

### **Clerk基盤構築** (0/5項目完了) - Week 1

#### 必須タスク
- [ ] **Clerkアカウント作成・プロジェクト作成**
  - Clerkアカウント登録
  - アプリケーション作成
  - メール/パスワード認証有効化
  - Google OAuth有効化

- [ ] **Google OAuth設定**
  - Google Cloud Consoleプロジェクト作成
  - OAuth同意画面設定
  - OAuth 2.0 クライアントID作成
  - ClerkにGoogle認証情報設定

- [ ] **環境変数設定**
  - `.env.local`作成
  - Clerk API Keys設定
  - Vercel環境変数設定

- [ ] **パッケージインストール**
  ```bash
  pnpm add @clerk/nextjs
  ```

- [ ] **ClerkProvider設定**
  - `app/layout.tsx`にClerkProvider追加
  - 日本語ローカライゼーション設定

**実装状況**: ❌ 未着手  
**優先度**: 🔴 最高（Phase 2開始前に必須）  
**担当**: 全員  
**期限**: Week 1完了まで

---

### **認証機能実装** (0/6項目完了) - Week 1-2

#### サインアップ（新規登録）機能
- [ ] **サインアップページ作成**
  - `app/sign-up/[[...sign-up]]/page.tsx`
  - Clerk `<SignUp />`コンポーネント統合
  - Google OAuthボタン表示
  - カスタムスタイリング適用

- [ ] **デフォルトロール設定**
  - 新規ユーザーに`supporter`ロールを自動設定
  - Public Metadataへの保存

#### ログイン機能
- [ ] **ログインページ作成**
  - `app/sign-in/[[...sign-in]]/page.tsx`
  - Clerk `<SignIn />`コンポーネント統合
  - Google OAuthボタン表示
  - カスタムスタイリング適用

- [ ] **Middleware設定**
  - `middleware.ts`作成（プロジェクトルート）
  - 保護ルート設定（`/dashboard/*`, `/api/*`）
  - 公開ルート設定（`/`, `/sign-in`, `/sign-up`）

#### ログアウト機能
- [ ] **ログアウトボタン作成**
  - `components/auth/logout-button.tsx`
  - Clerk `signOut()`統合
  - リダイレクト処理

- [ ] **ユーザーボタン作成**
  - `components/auth/user-button.tsx`
  - Clerk `<UserButton />`コンポーネント統合
  - カスタムスタイリング適用

**実装状況**: ❌ 未着手  
**優先度**: 🔴 高（MVP必須）  
**担当**: 担当者1  
**期限**: Week 2完了まで

---

### **RBAC（ロールベースアクセス制御）** (0/5項目完了) - Week 2-3

- [ ] **権限定義実装**
  - `lib/rbac.ts`作成
  - `permissions`定義（supporter/admin）
  - `getCurrentUserRole()`関数（Server）
  - `hasPermission()`関数（Server）
  - `isAdmin()`関数（Server）

- [ ] **クライアントサイドフック**
  - `hooks/use-user-role.ts`作成
  - `useUserRole`フック実装
  - Public Metadataからロール取得

- [ ] **保護ルートコンポーネント**
  - `components/auth/protected-route.tsx`作成
  - 権限チェック機能
  - アクセス拒否時のリダイレクト

- [ ] **アクセス拒否画面**
  - `app/access-denied/page.tsx`作成
  - エラーメッセージ表示

- [ ] **各画面への権限チェック適用**
  - ダッシュボード: `dashboard:read`
  - 会話データ: `conversation:read`, `conversation:write`
  - データインポート: `import:read`, `import:write`
  - ユーザー管理: `admin`のみ

**実装状況**: ❌ 未着手  
**優先度**: 🔴 高（MVP必須）  
**担当**: 担当者2  
**期限**: Week 3完了まで

---

### **セッション管理** (0/4項目完了) - Week 3-4

- [ ] **セッションタイムアウト実装**
  - `hooks/use-session-timeout.ts`作成
  - 30分無操作タイムアウト監視
  - ユーザー操作イベント監視
  - 自動ログアウト処理

- [ ] **未保存データ保存機能**
  - LocalStorageへのデータ保存
  - `data-autosave`属性付きフォームの自動保存
  - タイムアウト時の自動保存トリガー

- [ ] **データ復元機能**
  - `lib/session-storage.ts`作成
  - `restoreUnsavedData()`関数
  - `clearUnsavedData()`関数
  - 1時間以上古いデータの自動削除

- [ ] **ダッシュボードレイアウト統合**
  - `components/dashboard/dashboard-layout.tsx`更新
  - `useSessionTimeout`フック統合
  - タイムアウト通知表示

**実装状況**: ❌ 未着手  
**優先度**: 🔴 高（MVP必須）  
**担当**: 担当者1  
**期限**: Week 4完了まで

---

### **ユーザー管理機能** (0/4項目完了) - Week 4-5

- [ ] **Server Actions実装**
  - `app/actions/user-management.ts`作成
  - `setUserRole()`関数（ロール変更）
  - `getUsers()`関数（ユーザー一覧取得）
  - `deleteUser()`関数（ユーザー削除）

- [ ] **ユーザー管理画面**
  - `app/admin/users/page.tsx`作成
  - 管理者権限チェック
  - ユーザー一覧表示

- [ ] **ユーザー管理テーブル**
  - `components/admin/user-management-table.tsx`作成
  - ユーザー情報表示
  - ロール変更UI
  - ユーザー削除ボタン

- [ ] **管理者ナビゲーション**
  - ダッシュボードに「ユーザー管理」リンク追加
  - 管理者のみ表示

**実装状況**: ❌ 未着手  
**優先度**: 🟡 中（Phase 2推奨）  
**担当**: 担当者2  
**期限**: Week 5完了まで

---

### **モック削除・移行** (0/3項目完了) - Week 5

- [ ] **モックファイル削除**
  - `lib/mock-auth.ts`削除
  - `components/auth/login-form.tsx`削除
  - `app/login/`ディレクトリ削除

- [ ] **インポート修正**
  - モック実装を使用している箇所を検索
  - Clerk実装への置き換え
  - エラーチェック

- [ ] **動作確認**
  - 全画面でのログイン動作確認
  - RBAC動作確認
  - セッションタイムアウト動作確認

**実装状況**: ❌ 未着手  
**優先度**: 🟡 中（Phase 2完了時）  
**担当**: 全員  
**期限**: Week 5完了まで

---

## 2. フェーズ別実装計画

### **Phase 1: MVP UI実装（完了✅）**

**期間**: 要件定義〜UI実装（完了）

**完了項目**:
- ✅ ログインUI実装（モック）
- ✅ モック認証ロジック実装
- ✅ LocalStorageベースのセッション管理

**成果物**:
- 動作するログイン画面（モック実装）
- モックユーザーでのログイン・ログアウト機能

**完了日**: 2024年1月

---

### **Phase 2: Clerk統合（次フェーズ🔥）**

**予定期間**: 5週間（Week 1-5）  
**開発体制**: 2名体制  
**開始予定**: 2ヶ月以内

#### Week 1: Clerk基盤構築
**担当**: 全員

- [ ] Clerkアカウント作成・プロジェクト作成
- [ ] Google OAuth設定
- [ ] 環境変数設定
- [ ] パッケージインストール
- [ ] ClerkProvider設定

**成果物**:
- Clerk統合済みの開発環境
- Google OAuth動作確認

---

#### Week 2: 認証機能実装
**担当**: 担当者1

- [ ] サインアップページ作成
- [ ] ログインページ作成
- [ ] Middleware設定
- [ ] ログアウトボタン作成
- [ ] ユーザーボタン作成

**成果物**:
- 動作するログイン・サインアップ画面
- Google OAuth認証

---

#### Week 3: RBAC実装
**担当**: 担当者2

- [ ] 権限定義実装
- [ ] クライアントサイドフック
- [ ] 保護ルートコンポーネント
- [ ] アクセス拒否画面
- [ ] 各画面への権限チェック適用

**成果物**:
- ロールベースアクセス制御
- 権限に応じた画面表示

---

#### Week 4: セッション管理実装
**担当**: 担当者1

- [ ] セッションタイムアウト実装
- [ ] 未保存データ保存機能
- [ ] データ復元機能
- [ ] ダッシュボードレイアウト統合

**成果物**:
- 30分無操作タイムアウト
- 自動データ保存・復元

---

#### Week 5: ユーザー管理＋モック削除
**担当**: 全員

- [ ] Server Actions実装
- [ ] ユーザー管理画面
- [ ] モックファイル削除
- [ ] インポート修正
- [ ] 動作確認

**成果物**:
- 管理者向けユーザー管理機能
- モック実装完全削除
- Clerk統合完了

---

### **Phase 3: パスワードリセット（Phase 2後）**

**予定期間**: 1週間

**実装予定項目**:
- [ ] Clerkパスワードリセット機能の活用
- [ ] カスタムメールテンプレート（将来）
- [ ] エラーハンドリング

**優先度**: 🟡 中

---

### **Phase 5: MFA対応（本番運用開始後）**

**予定期間**: 2週間

**実装予定項目**:
- [ ] SMS認証統合（Clerk組み込み）
- [ ] 認証アプリ（TOTP）統合
- [ ] バックアップコード生成
- [ ] セキュリティテスト

**優先度**: 🟢 低（本番運用後）

---

## 3. 技術的依存関係

### 外部サービス
- **Clerk**: 認証基盤（メール/パスワード、Google OAuth）
- **Google OAuth**: 外部認証プロバイダー
- **Vercel**: ホスティング、環境変数管理

### 内部依存
- **すべての機能**: F-005に依存（認証・認可が必要）
- **F-004（ダッシュボード）**: RBAC統合必須
- **F-001〜F-008**: 権限チェック適用

---

## 4. タスク管理

### 🔴 最高優先（Week 1）

1. **Clerkアカウント作成・プロジェクト作成**
   - [ ] Clerkアカウント登録
   - [ ] アプリケーション作成
   - [ ] メール/パスワード認証有効化
   - [ ] Google OAuth有効化

2. **Google OAuth設定**
   - [ ] Google Cloud Consoleプロジェクト作成
   - [ ] OAuth同意画面設定
   - [ ] OAuth 2.0 クライアントID作成
   - [ ] ClerkにGoogle認証情報設定

3. **環境変数設定**
   - [ ] `.env.local`作成
   - [ ] Clerk API Keys設定
   - [ ] Vercel環境変数設定

4. **パッケージインストール**
   ```bash
   pnpm add @clerk/nextjs
   ```

5. **ClerkProvider設定**
   - [ ] `app/layout.tsx`更新
   - [ ] 日本語ローカライゼーション

---

### 🔴 高優先（Week 2-3）

1. **認証機能実装**（Week 2）
   - [ ] サインアップページ
   - [ ] ログインページ
   - [ ] Middleware設定
   - [ ] ログアウト機能

2. **RBAC実装**（Week 3）
   - [ ] 権限定義
   - [ ] 保護ルート
   - [ ] 権限チェックフック

---

### 🟡 中優先（Week 4-5）

1. **セッション管理**（Week 4）
   - [ ] タイムアウト監視
   - [ ] 自動ログアウト
   - [ ] データ保存・復元

2. **ユーザー管理機能**（Week 5）
   - [ ] Server Actions
   - [ ] ユーザー管理画面
   - [ ] ロール変更UI

3. **モック削除**（Week 5）
   - [ ] モックファイル削除
   - [ ] インポート修正
   - [ ] 動作確認

---

### 🟢 低優先（Phase 3以降）

1. **パスワードリセット** (Phase 3)
   - [ ] Clerkパスワードリセット活用
   - [ ] カスタムメールテンプレート

2. **MFA対応** (Phase 5)
   - [ ] SMS認証
   - [ ] 認証アプリ（TOTP）
   - [ ] バックアップコード

---

## 5. リスクと対応策

### 技術的リスク

| リスク | 影響度 | 発生確率 | 対応策 | 状態 |
|--------|--------|---------|--------|------|
| Clerk設定ミス | 高 | 中 | ドキュメント精読、動作確認 | ⚠️ 監視中 |
| Google OAuth設定漏れ | 高 | 中 | 段階的テスト、検証 | ⚠️ 監視中 |
| Public Metadata設定漏れ | 高 | 中 | デフォルトロール設定、検証ロジック | ⚠️ 監視中 |
| セッション管理の不具合 | 中 | 中 | 十分なテスト、段階的リリース | ⚠️ 監視中 |
| Clerk料金超過 | 中 | 低 | 無料枠監視（月5,000ユーザー） | ⏸️ 未対応 |

### ビジネスリスク

| リスク | 影響度 | 発生確率 | 対応策 | 状態 |
|--------|--------|---------|--------|------|
| Google OAuth不達 | 中 | 低 | メール/パスワード認証で代替 | ⚠️ 監視中 |
| RBAC設定ミスによる情報漏洩 | 高 | 低 | コードレビュー、テスト徹底 | ⚠️ 監視中 |
| ユーザーのClerk UI不慣れ | 中 | 中 | カスタムスタイリング、ヘルプ表示 | ⏸️ 未対応 |

---

## 6. テスト計画

### ユニットテスト
- [ ] `lib/rbac.ts` - 権限チェック関数
- [ ] `lib/session-storage.ts` - データ保存・復元ロジック

### 統合テスト
- [ ] ログイン → RBAC → ダッシュボード表示
- [ ] Google OAuth → ロール設定 → ダッシュボード表示
- [ ] セッションタイムアウト → 自動ログアウト

### E2Eテスト（Playwright）
- [ ] サインアップフロー（メール/パスワード）
- [ ] ログインフロー（メール/パスワード）
- [ ] Google OAuthフロー
- [ ] 権限不足でのアクセス拒否
- [ ] セッションタイムアウト
- [ ] ユーザー管理フロー（管理者のみ）

### セキュリティテスト
- [ ] XSS対策
- [ ] CSRF対策（Clerk自動対応）
- [ ] 権限チェック動作確認
- [ ] セッション管理確認

---

## 7. ドキュメント

### 完成ドキュメント ✅
- [x] README.md - Clerk統合の概要、目的、技術仕様
- [x] implementation-notes.md - Clerk実装手順、コード例
- [x] status.md - 実装状況、フェーズ別計画

### 未作成ドキュメント
- [ ] API仕様書（Server Actions）
- [ ] セキュリティガイドライン
- [ ] 運用マニュアル（管理者向け）
- [ ] トラブルシューティングガイド

---

## 8. 今後の優先タスク（Phase 2開始前）

### 最優先（今週中）

1. **Clerkアカウント作成・プロジェクト作成**
   - Clerkアカウント登録
   - アプリケーション作成
   - API Keys取得

2. **Google OAuth設定**
   - Google Cloud Consoleプロジェクト作成
   - OAuth 2.0 クライアントID作成
   - Clerkへの設定

3. **環境変数設定**
   - `.env.local`作成
   - Vercel環境変数設定

---

### 高優先（Phase 2開始後）

1. **認証機能実装**（Week 1-2）
2. **RBAC実装**（Week 2-3）
3. **セッション管理実装**（Week 3-4）
4. **ユーザー管理機能**（Week 4-5）

---

## 9. Clerk料金プラン

### 無料プラン（開発・初期運用）
- **月間アクティブユーザー**: 5,000まで無料
- **認証方法**: メール/パスワード、Google OAuth無制限
- **セッション管理**: 無制限
- **サポート**: コミュニティサポート

### 初期段階での想定
- 初年度: 2施設×10ユーザー = **20ユーザー**（無料枠で十分）
- 2年目: 4施設×10ユーザー = **40ユーザー**（無料枠で十分）
- 3年目: 8施設×10ユーザー = **80ユーザー**（無料枠で十分）

**結論**: 初期段階は無料プランで対応可能

---

## 10. 更新履歴

| 日付 | 更新内容 | 担当 |
|------|---------|------|
| 2025-10-23 | 初版作成、Clerk統合計画策定 | AI |
| - | - | - |

---

**凡例**:
- ✅ 完了
- ⏳ 進行中
- ⚠️ 注意・監視中
- ⏸️ 未着手
- ❌ MVP対象外
- 🔥 次フェーズ優先
- 🔴 最高優先度
- 🟡 中優先度
- 🟢 低優先度

**最終更新**: 2025年10月23日  
**ステータス**: Phase 1完了（モックUI）、Phase 2準備中（Clerk統合）  
**次のマイルストーン**: Phase 2開始（2ヶ月以内）→ Clerk統合完了（5週間）
