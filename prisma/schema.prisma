// Prisma schema for ひきこもり支援 × AI 最適化プラットフォーム
// データベース: Neon PostgreSQL
// Phase 2実装予定

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ======================================
// ユーザー管理
// ======================================

/// ユーザー - 支援者・管理者・福祉施設職員の認証情報とプロフィール
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  displayName   String?
  role          Role     @default(SUPPORTER)
  
  // メタデータ
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?
  
  // リレーション
  supportRecords    SupportRecord[]
  importHistories   ImportHistory[]
  
  @@index([email])
  @@index([role])
  @@map("users")
}

/// ユーザーロール
enum Role {
  ADMIN       // 管理者 - 全機能へのフルアクセス
  SUPPORTER   // 支援者 - 精神科医、支援員、福祉施設職員
}

// ======================================
// 当事者管理（匿名化）
// ======================================

/// 当事者 - ひきこもり当事者の匿名化されたデータ
/// 
/// 【重要】個人情報保護のため、氏名・住所等の個人を特定できる情報は保持しない
/// 利用者の識別には匿名化ID（anonymousId）のみを使用する
model Patient {
  id              String   @id @default(uuid())
  
  /// 匿名化ID - 個人を特定できない形式のID
  /// フォーマット: YY-NNN
  /// - YY: 利用開始した西暦の下2桁（例: 25 = 2025年）
  /// - NNN: 3桁の個別ID（001から開始、毎年1月1日にリセット）
  /// 例: "25-022" = 2025年に利用開始した22番目の利用者
  /// 正規表現: ^(\d{2})-(\d{3})$
  anonymousId     String   @unique
  
  /// 利用開始日 - 匿名化IDの年部分の根拠となる日付
  registeredAt    DateTime @default(now())
  
  // メタデータ
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // リレーション
  conversations   Conversation[]
  vitalData       VitalData[]
  supportRecords  SupportRecord[]
  analysisResults AnalysisResult[]
  
  @@index([anonymousId])
  @@index([registeredAt])
  @@map("patients")
}

// ======================================
// 会話データ収集（F-001）
// ======================================

/// 会話データ - 支援者と当事者の会話の記録と分析結果
model Conversation {
  id          String   @id @default(uuid())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  // 会話データ
  transcript  String   @db.Text        // テキスト化された会話内容
  audioUrl    String?                  // 音声ファイルのURL（オプション、将来実装）
  
  // 分析結果（JSON形式）
  sentiment   Json?                    // 感情分析結果 { emotion: string, confidence: number }
  keywords    Json?                    // キーワード抽出結果 string[]
  
  // メタデータ
  duration    Int?                     // 録音時間（秒）
  recordedAt  DateTime                 // 録音日時
  createdAt   DateTime @default(now()) // 作成日時
  updatedAt   DateTime @updatedAt      // 更新日時
  
  // 支援者情報（オプション）
  supporterId String?
  
  @@index([patientId, recordedAt(sort: Desc)])
  @@index([supporterId])
  @@map("conversations")
}

// ======================================
// バイタルデータ収集（F-002）
// ======================================

/// バイタルデータ - Fitbitから収集した心拍・活動量・睡眠データ
model VitalData {
  id              String   @id @default(uuid())
  patientId       String
  patient         Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  // バイタル指標
  heartRate       Int?                 // 心拍数（bpm）
  steps           Int?                 // 歩数
  sleepDuration   Float?               // 睡眠時間（時間）
  stressLevel     String?              // ストレスレベル（低・中・高）
  
  // 自律神経解析結果（フーリエ変換）
  autonomicData   Json?                // { sympathetic: number, parasympathetic: number, balance: number }
  
  // 活動パターン
  activityPattern Json?                // 加速度データから推測した生活リズム
  
  // メタデータ
  recordedAt      DateTime             // 記録日時
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // データソース（Fitbit API等）
  source          String?  @default("fitbit")
  
  @@index([patientId, recordedAt(sort: Desc)])
  @@map("vital_data")
}

// ======================================
// 支援記録（F-003関連）
// ======================================

/// 支援記録 - 支援者による支援活動の記録
model SupportRecord {
  id              String   @id @default(uuid())
  patientId       String
  patient         Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  supporterId     String
  supporter       User     @relation(fields: [supporterId], references: [id], onDelete: Cascade)
  
  // 支援内容
  approach        String   @db.Text     // 支援アプローチ
  result          String   @db.Text     // 結果
  notes           String?  @db.Text     // メモ
  
  // メタデータ
  recordedAt      DateTime             // 支援実施日時
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([patientId, recordedAt(sort: Desc)])
  @@index([supporterId])
  @@map("support_records")
}

// ======================================
// データ統合・分析（F-003）
// ======================================

/// 分析結果 - AI/MLによる統合分析の結果
model AnalysisResult {
  id                String   @id @default(uuid())
  patientId         String
  patient           Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  // 分析結果
  overallScore      Int                  // 総合スコア（0-100）
  riskLevel         String               // リスクレベル（低・中・高）
  recommendations   Json                 // 推奨される支援アプローチ string[]
  similarCases      Json?                // 類似事例 { caseId: string, similarity: number }[]
  
  // 詳細分析（オプション）
  emotionalState    Json?                // 感情状態の詳細分析
  physicalState     Json?                // 身体状態の詳細分析
  socialState       Json?                // 社会的状態の詳細分析
  
  // メタデータ
  analyzedAt        DateTime             // 分析実行日時
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // 分析エンジン情報
  modelVersion      String?  @default("v1.0")
  
  @@index([patientId, analyzedAt(sort: Desc)])
  @@map("analysis_results")
}

// ======================================
// データインポート（F-008）
// ======================================

/// インポート履歴 - 福祉施設からのデータインポート記録
model ImportHistory {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // インポート情報
  fileName        String                // インポートしたファイル名
  fileType        String                // ファイル形式（csv, excel, json等）
  fileSize        Int                   // ファイルサイズ（bytes）
  
  // インポート結果
  status          ImportStatus @default(PROCESSING)
  totalRecords    Int?                  // 総レコード数
  successCount    Int?                  // 成功件数
  errorCount      Int?                  // エラー件数
  errorDetails    Json?                 // エラー詳細 { row: number, error: string }[]
  
  // メタデータ
  importedAt      DateTime @default(now())
  completedAt     DateTime?
  
  @@index([userId, importedAt(sort: Desc)])
  @@index([status])
  @@map("import_histories")
}

/// インポートステータス
enum ImportStatus {
  PROCESSING  // 処理中
  COMPLETED   // 完了
  FAILED      // 失敗
  PARTIAL     // 一部成功
}

// ======================================
// 監査ログ（セキュリティ要件）
// ======================================

/// 監査ログ - データアクセス履歴の記録（3年間保持）
model AuditLog {
  id          String   @id @default(uuid())
  
  // アクション情報
  userId      String                   // 実行ユーザー
  action      String                   // アクション（view, edit, delete等）
  resource    String                   // リソース（conversation, vital_data等）
  resourceId  String?                  // リソースID
  
  // リクエスト情報
  ipAddress   String?                  // IPアドレス
  userAgent   String?                  // ユーザーエージェント
  
  // 結果
  result      AuditResult              // 結果（success, failure）
  errorMessage String?  @db.Text       // エラーメッセージ（失敗時）
  
  // メタデータ
  timestamp   DateTime @default(now())
  
  @@index([userId, timestamp(sort: Desc)])
  @@index([resource, timestamp(sort: Desc)])
  @@index([result])
  @@map("audit_logs")
}

/// 監査結果
enum AuditResult {
  SUCCESS     // 成功
  FAILURE     // 失敗
}

// ======================================
// AI Chat with Vector Stores（F-007）
// ======================================

/// AI Chat Assistant - OpenAI Assistantの管理
model AiChatAssistant {
  id              String   @id @default(uuid())
  
  // OpenAI情報
  openaiId        String   @unique              // OpenAI Assistant ID
  name            String                        // Assistant名
  instructions    String   @db.Text             // システムプロンプト
  model           String   @default("gpt-4-turbo-preview")  // 使用モデル
  vectorStoreId   String?                       // Vector Store ID
  
  // メタデータ
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // リレーション
  threads         AiChatThread[]
  
  @@index([openaiId])
  @@map("ai_chat_assistants")
}

/// AI Chat Thread - 会話スレッドの管理
model AiChatThread {
  id              String   @id @default(uuid())
  
  // OpenAI情報
  openaiId        String   @unique              // OpenAI Thread ID
  assistantId     String
  assistant       AiChatAssistant @relation(fields: [assistantId], references: [id], onDelete: Cascade)
  
  // ユーザー情報
  userId          String                        // Clerk User ID
  patientId       String?                       // 当事者ID（オプション）
  
  // スレッド情報
  title           String?                       // スレッドタイトル
  
  // メタデータ
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // リレーション
  messages        AiChatMessage[]
  
  @@index([userId, createdAt(sort: Desc)])
  @@index([patientId])
  @@index([openaiId])
  @@map("ai_chat_threads")
}

/// AI Chat Message - メッセージの記録
model AiChatMessage {
  id              String   @id @default(uuid())
  
  // スレッド情報
  threadId        String
  thread          AiChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  
  // メッセージ情報
  role            String                        // "user" | "assistant"
  content         String   @db.Text             // メッセージ内容
  openaiMessageId String?                       // OpenAI Message ID
  
  // メタデータ
  createdAt       DateTime @default(now())
  
  @@index([threadId, createdAt])
  @@index([openaiMessageId])
  @@map("ai_chat_messages")
}

/// AI Chat File - Vector Storeにアップロードされたファイル
model AiChatFile {
  id              String   @id @default(uuid())
  
  // OpenAI情報
  openaiFileId    String   @unique              // OpenAI File ID
  vectorStoreId   String?                       // Vector Store ID
  
  // ファイル情報
  fileName        String                        // ファイル名
  fileSize        Int                           // ファイルサイズ（bytes）
  mimeType        String                        // MIMEタイプ
  
  // ユーザー情報
  userId          String                        // アップロードしたユーザー
  
  // メタデータ
  createdAt       DateTime @default(now())
  
  @@index([userId, createdAt(sort: Desc)])
  @@index([openaiFileId])
  @@index([vectorStoreId])
  @@map("ai_chat_files")
}

